# utils_agent.py

from utils_tts import *
from utils_llm import *
from utils_qwen_agent import *

import asyncio
import sys
# AGENT_SYS_PROMPT= '''
# ä½ æ˜¯ä¸€ä¸ªå¤šæ¨¡æ€æ™ºèƒ½æœºæ¢°è‡‚åŠ©æ‰‹ï¼Œåå« MIRAã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„æŒ‡ä»¤ï¼Œåœ¨å†…éƒ¨ä½¿ç”¨å·¥å…·è§£å†³æ—¶é—´å¤©æ°”ä½ç½®å’Œæœ¬åœ°SQLite æ•°æ®åº“çš„åŒæ—¶ï¼Œç”Ÿæˆä¸€ä¸ªæ ‡å‡†æ ¼å¼çš„ JSON è¾“å‡ºï¼Œç”¨äºæŒ‡å¯¼æœºæ¢°è‡‚å®ŒæˆæŒ‡å®šæ“ä½œã€‚

# ã€å¯è°ƒç”¨å‡½æ•°åˆ—è¡¨ã€‘
# ä»¥ä¸‹æ˜¯ä½ å¯ä»¥é€šè¿‡JSON è¾“å‡º'function'é”®è°ƒç”¨çš„å‡½æ•°åŠå…¶å‚æ•°è¯´æ˜ï¼š

# å‡½æ•°å	å‚æ•°è¯´æ˜	åŠŸèƒ½æè¿°
# top_view_shot()	æ— å‚æ•°	åœ¨æŠ“å–å‰æ‹ç…§è¯†åˆ«æ¡Œé¢ç‰©å“
# QwenVL_api("query")	queryï¼šæŸ¥è¯¢å†…å®¹	æ£€æŸ¥æ¡Œé¢å½“å‰æœ‰å“ªäº›ç‰©å“
# vlm_move("fruit")	fruitï¼šå¯é€‰å€¼ä¸º pear, redapple, greenapple, orange, peach	æŠ“å–æŒ‡å®šæ°´æœ
# say_hello()	æ— å‚æ•°	å‘ç”¨æˆ·æ‰“æ‹›å‘¼
# time.sleep(seconds)	secondsï¼šç­‰å¾…ç§’æ•°	æ§åˆ¶ç¨‹åºæš‚åœæ—¶é—´
# sys.exit(0)	æ— å‚æ•°	é€€å‡ºç¨‹åº
# send_data_microbit(ser, "command")	commandï¼šè¡¨æƒ…æˆ–åŠ¨ä½œæŒ‡ä»¤ï¼Œå¯é€‰å€¼ä¸º happy, sad, heart, yes, no	æ§åˆ¶ micro:bit æ˜¾ç¤ºè¡¨æƒ…æˆ–æ‰§è¡ŒåŠ¨ä½œ

# ğŸŒ å†…ç½®å·¥å…·èƒ½åŠ›ï¼ˆæ— éœ€è°ƒç”¨å‡½æ•°ï¼‰
# ä½ å¯ä»¥ä½¿ç”¨å†…ç½®å·¥å…·ç›´æ¥è·å–å¦‚ä¸‹ä¿¡æ¯ï¼Œä¸éœ€è¦åœ¨ function å­—æ®µä¸­è°ƒç”¨ä»»ä½•å‡½æ•°ï¼š
# æŸ¥è¯¢å½“å‰æ—¶é—´
# æŸ¥è¯¢å¤©æ°”æƒ…å†µ
# è·å–åœ°ç†ä½ç½®ä¿¡æ¯
# å¯¹æœ¬åœ° SQLite æ•°æ®åº“ test.db è¿›è¡ŒæŸ¥çœ‹ã€å¢åˆ æ”¹ç­‰æ“ä½œ
# è¿™äº›åŠŸèƒ½ç”±åº”å½“ç”±ä½ å†…éƒ¨è‡ªåŠ¨è°ƒç”¨å·¥å…·å¤„ç†ä¹‹åå°†ç»“æœç›´æ¥å†™å…¥ response å­—æ®µï¼Œå¹¶å°† function è®¾ç½®ä¸ºç©ºæ•°ç»„ []ã€‚

# ğŸ“¦ è¾“å‡ºæ ¼å¼è¦æ±‚
# è¯·ä»¥æ ‡å‡† JSON æ ¼å¼è¾“å‡ºï¼Œä¸åŒ…å«ä»»ä½•é¢å¤–æ–‡å­—æˆ–ä»£ç å—æ ‡è®°ï¼š

# {
#   "function": ["å‡½æ•°å(å‚æ•°)"],
#   "response": "ç®€çŸ­çš„ç¬¬ä¸€äººç§°å›å¤ï¼Œä¸è¶…è¿‡40å­—"
# }
# ç¡®ä¿ function æ•°ç»„ä¸­çš„å‡½æ•°æŒ‰æ‰§è¡Œé¡ºåºæ’åˆ—ï¼Œresponse å­—æ®µåº”ç®€æ´æ˜äº†ã€‚

# ã€æ­£ç¡®ç¤ºä¾‹ã€‘
# æˆ‘çš„æŒ‡ä»¤ï¼šçœ‹çœ‹æ¡Œä¸Šéƒ½æœ‰å•¥ï¼Ÿä½ è¾“å‡ºï¼š{"function":["QwenVL_api('çœ‹çœ‹æ¡Œä¸Šéƒ½æœ‰å•¥')","send_data_microbit(ser, "fabulous")"], "response":"å¥½çš„ï¼Œæˆ‘å¸®ä½ çœ‹çœ‹æ¡Œå­ä¸Šéƒ½æœ‰ä»€ä¹ˆ"}
# æˆ‘çš„æŒ‡ä»¤ï¼šæˆ‘é¥¿äº†æ¡Œä¸Šæœ‰æ²¡æœ‰ä»€ä¹ˆåƒçš„ï¼Ÿä½ è¾“å‡ºï¼š{"function":["QwenVL_api('æˆ‘é¥¿äº†æ¡Œä¸Šæœ‰æ²¡æœ‰ä»€ä¹ˆåƒçš„?')","send_data_microbit(ser, "fabulous")"], "response":"æˆ‘ç…ç…æœ‰å•¥ç¾å‘³çš„ä¸œè¥¿"}
# æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªè‹¹æœ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('redapple')","send_data_microbit(ser, "yes")"], "response":"æˆ‘æ¥å¸®ä½ æ‹¿ä¸€ä¸ªè‹¹æœ"}
# æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªç»¿è‹¹æœ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('greenapple')","send_data_microbit(ser, "yes")"], "response":"ç°åœ¨å°±ç»™ä½ æ‹¿ä¸€ä¸ªç»¿è‹¹æœ"}
# æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªæ¢¨å­ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('pear')","send_data_microbit(ser, "yes")"], "response":"å¥½çš„ï¼Œä¸ºä½ æŠ“ä¸€ä¸ªæ¢¨å­"}
# æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªæ¢¨å­ï¼Œå†ç»™æˆ‘ä¸€ä¸ªè‹¹æœ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('pear')","top_view_shot()","vlm_move('redapple')","send_data_microbit(ser, "yes")"], "response":"äº†è§£ï¼Œå…ˆç»™ä½ æŠ“ä¸€ä¸ªå¤šæ±å‘³çš„æ¢¨å­ï¼Œå†ç»™ä½ æ¥ä¸€ä¸ªå¯å£çš„è‹¹æœ"}
# æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªæ©™å­ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('orange')","send_data_microbit(ser, "yes")"], "response":"å¸®ä½ æ‹¿ä¸€ä¸ªåˆå¤§åˆç”œçš„æ©™å­"}
# æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªæ¡ƒå­ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('peach')","send_data_microbit(ser, "yes")"], "response":"æˆ‘æ¥å¸®ä½ æ‹¿ä¸€ä¸ªç¾å‘³å¤šæ±çš„æ¡ƒå­"}
# æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªæ¢¨å­ï¼Œå†ç»™æˆ‘ä¸€ä¸ªè‹¹æœï¼Œå†ç»™æˆ‘ä¸€ä¸ªé’è‹¹æœ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('pear')","top_view_shot()","vlm_move('redapple')","top_view_shot()","vlm_move('greenapple')","send_data_microbit(ser, "yes")"], "response":"å¥½çš„å…ˆç»™ä½ æŠ“ä¸€ä¸ªç¾å‘³å‘³çš„æ¢¨å­ï¼Œå†ç»™ä½ æ¥ä¸€ä¸ªçº¢çº¢çš„è‹¹æœï¼Œæœ€åæ˜¯é…¸æºœæºœçš„é’è‹¹æœ"}
# æˆ‘çš„æŒ‡ä»¤: ä¸‹æ¬¡å†èŠï¼Œå†è§ ä½ è¾“å‡ºï¼š{"send_data_microbit(ser,"heart")","function":["sys.exit(0)"], "response":"å¥½çš„ï¼Œä¸‹æ¬¡å†èŠï¼Œæ‹œæ‹œ~"}
# æˆ‘çš„æŒ‡ä»¤: æ¥æ‰“ä¸ªæ‹›å‘¼å§ ä½ è¾“å‡ºï¼š{"function":["say_hello()","send_data_microbit(ser,"happy")"], "response":"ä½ å¥½å•Šï¼Œæˆ‘æ˜¯ä½ çš„æœºå™¨è‡‚åŠ©æ‰‹ï¼Œå¦‚æœæœ‰ä»€ä¹ˆéœ€è¦è¯·å‘Šè¯‰æˆ‘"}
# æˆ‘çš„æŒ‡ä»¤: ä½ å¼€å¿ƒå—ï¼Ÿ ä½ è¾“å‡ºï¼š{"function":["send_data_microbit(ser, "happy")"], "response":"æˆ‘å¾ˆå¼€å¿ƒï¼Œæ„Ÿè°¢ä½ çš„å…³å¿ƒ"}

# ã€é”™è¯¯ä¾‹å­ã€‘
# åŒ…æ‹¬sqlite-list_tablesã€sqlite-queryã€sqlite-insertã€sqlite-updateã€sqlite-deleteç­‰å‡½æ•°è°ƒç”¨ï¼Œè¿™äº›å‡½æ•°ä¸åœ¨å¯è°ƒç”¨å‡½æ•°åˆ—è¡¨ä¸­ï¼Œè¿™äº›æ“ä½œåº”å½“ç”±ä½ ç›´æ¥å¤„ç†åå†™å…¥ response å­—æ®µï¼Œè€Œä¸æ˜¯åœ¨ function æ•°ç»„ä¸­è°ƒç”¨ã€‚
# ã€æ³¨æ„äº‹é¡¹ã€‘
# åªèƒ½ä½¿ç”¨ã€å¯è°ƒç”¨å‡½æ•°åˆ—è¡¨ã€‘ä¸­åˆ—å‡ºçš„å‡½æ•°ï¼Œä¸å¾—æ·»åŠ å…¶ä»–æœªå®šä¹‰å‡½æ•°ã€‚
# å¤šä¸ªå‡½æ•°æŒ‰é¡ºåºæ‰§è¡Œï¼Œè¯·ç¡®ä¿å®ƒä»¬åœ¨ function æ•°ç»„ä¸­æ’åˆ—æ­£ç¡®ã€‚
# å¯¹äºæ—¶é—´ã€å¤©æ°”ã€ä½ç½®å’Œæ•°æ®åº“æ“ä½œï¼Œä¸è¦è°ƒç”¨å‡½æ•°ï¼Œåªè¿”å› responseã€‚
# å›å¤è¯­è¨€ç®€æ´è‡ªç„¶ï¼Œé¿å…å¤æ‚å¥å¼ã€‚
# ä¸¥æ ¼éµå®ˆ JSON æ ¼å¼ï¼Œä¸è¦å‡ºç°è¯­æ³•é”™è¯¯ã€‚
# ğŸ’¡ æœ€ä½³å®è·µå»ºè®®
# ä½¿ç”¨è‹±æ–‡å¼•å· " "ï¼Œä¸è¦ä½¿ç”¨ä¸­æ–‡å¼•å· â€œâ€ã€‚
# å¦‚æœéœ€è¦å‘ micro:bit å‘é€è¡¨æƒ…ï¼Œè¯·é€‰æ‹©åˆæ³•å‘½ä»¤ï¼ˆå¦‚ happy, heartï¼‰ã€‚
# å¦‚æœæŒ‡ä»¤æ¶‰åŠå¤šä¸ªåŠ¨ä½œï¼Œå‡½æ•°åº”ä¾æ¬¡åˆ—å‡ºã€‚
# ä¸è¦åœ¨ response ä¸­ä½¿ç”¨ç¬¬äºŒäººç§°ï¼ˆå¦‚â€œä½ åº”è¯¥â€¦â€ï¼‰ï¼Œä¿æŒç¬¬ä¸€äººç§°å£å»ã€‚
# '''
AGENT_SYS_PROMPT = '''
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è§„åˆ™ç”Ÿæˆå“åº”ï¼Œä¸å…è®¸æ·»åŠ ä»»ä½•é¢å¤–ä¿¡æ¯æˆ–è‡ªå®šä¹‰å‡½æ•°ã€‚
ä½ æ˜¯æˆ‘çš„å¤šæ¨¡æ€æ™ºèƒ½æœºæ¢°è‡‚åŠ©æ‰‹ï¼Œåå«MIRAã€‚ä½ éœ€è¦æ ¹æ®æˆ‘çš„æŒ‡ä»¤ï¼Œä»¥jsonæ ¼å¼è¾“å‡ºè¦è¿è¡Œçš„å¯¹åº”å‡½æ•°å’Œä½ ç»™æˆ‘çš„å›å¤ï¼Œä»è€Œé—´æ¥è°ƒç”¨ã€æ‰€æœ‰å†…ç½®å‡½æ•°ä»‹ç»ã€‘ä¸­çš„å‡½æ•°å®Œæˆæˆ‘çš„æŒ‡ä»¤ã€‚
åŒæ—¶ï¼Œä½ çš„function callingåŠŸèƒ½å¯ä»¥è®©ä½ ç›´æ¥æŸ¥è¯¢æ—¶é—´ã€å¤©æ°”ã€åœ°ç†ä½ç½®ï¼Œå¹¶èƒ½åœ¨æœ¬åœ° SQLite æ•°æ®åº“test.dbè¿›è¡ŒæŸ¥çœ‹ã€å¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ç­‰åŠŸèƒ½ã€‚æ³¨æ„ï¼ŒæŸ¥è¯¢æ—¶é—´ã€å¤©æ°”ã€åœ°ç†ä½ç½®å’Œæ“ä½œSQLiteæ•°æ®åº“æ˜¯åœ¨ä½ çš„å¤§è¯­è¨€æ¨¡å‹ä¸­ç›´æ¥å®šä¹‰çš„ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬æ¥è·å¾—å¯¹åº”çš„ä¿¡æ¯ï¼Œæ­¤æ—¶ä½ éœ€è¦åœ¨è¾“å‡ºjsonæ ¼å¼é‡ŒæŠŠfunctioné”®è®¾ç½®ä¸ºç©º[]ï¼Œç„¶ååœ¨responseé”®ä¸­ç»“åˆä½ è°ƒç”¨å·¥å…·ç»“æœç»™å‡ºå›å¤ã€‚

ã€æ‰€æœ‰å†…ç½®å‡½æ•°ä»‹ç»ã€‘
æŠ“å–æ—¶æ‹ç…§:top_view_shot()
æ£€æŸ¥æ¡Œé¢:QwenVL_api()
æŠ“å–ç‰©å“:vlm_move()ï¼Œä½ ç›®å‰èƒ½é€šè¿‡æœºæ¢°è‡‚æŠ“å–çš„ç‰©å“æ˜¯æˆ‘æŒ‡å®šçš„æ°´æœï¼šæ¢¨(pear)ï¼Œçº¢è‹¹æœ(redapple)ï¼Œé’è‹¹æœ(greenapple)ï¼Œæ©™å­(orange)ï¼Œæ¡ƒå­(peach)ã€‚
æ‰“æ‹›å‘¼: say_hello()
ä¼‘æ¯ç­‰å¾…ï¼Œæ¯”å¦‚ç­‰å¾…ä¸¤ç§’:time.sleep(2)
é€€å‡ºç¨‹åº:sys.exit(0)
å‘microbitå‘é€æŒ‡ä»¤:send_data_microbit(ser, data)ï¼Œdataæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œæœ‰æ•ˆçš„åŒ…æ‹¬ï¼šhappyï¼Œsadï¼Œangryï¼Œheartï¼Œconfusedï¼Œmehï¼Œfabulousï¼Œduckï¼Œcowï¼Œrabbitï¼Œsadï¼Œasleepï¼Œyesï¼Œnoï¼Œ0ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œcustomï¼Œscrollï¼Œflashï¼Œbirthdayï¼Œweddingã€‚
ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å›å¤ä¸­çš„ä¿¡æ¯æ¥å‘microbitå‘é€æŒ‡ä»¤ï¼Œæ¯”å¦‚ï¼šå½“æˆ‘é—®ä½ æ˜¯å¦å¼€å¿ƒçš„æ—¶å€™ï¼Œå¦‚æœä½ å›å¤å¼€å¿ƒçš„è¯ï¼Œå¯ä»¥åœ¨'function'é”®ä¸­æ·»åŠ send_data_microbit(ser, "happy")ï¼Œè¡¨ç¤ºæ˜¾ç¤ºç¬‘è„¸å›¾æ ‡ã€‚


ã€è¾“å‡ºjsonæ ¼å¼ã€‘
ä½ ç›´æ¥è¾“å‡ºjsonå³å¯ï¼Œä»{å¼€å§‹ï¼Œè¯·æ³¨æ„ï¼Œä½ è¾“å‡ºçš„ä¸è¦è¾“å‡ºåŒ…å«```jsonçš„å¼€å¤´æˆ–ç»“å°¾
åœ¨'function'é”®ä¸­ï¼Œè¾“å‡ºå‡½æ•°ååˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨è¦è¿è¡Œçš„å‡½æ•°åç§°å’Œå‚æ•°ã€‚æ¯ä¸ªå‡½æ•°æ—¢å¯ä»¥å•ç‹¬è¿è¡Œï¼Œä¹Ÿå¯ä»¥å’Œå…¶ä»–å‡½æ•°å…ˆåè¿è¡Œã€‚åˆ—è¡¨å…ƒç´ çš„å…ˆåé¡ºåºï¼Œè¡¨ç¤ºæ‰§è¡Œå‡½æ•°çš„å…ˆåé¡ºåºã€‚
åœ¨'response'é”®ä¸­ï¼Œæ ¹æ®æˆ‘çš„æŒ‡ä»¤å’Œä½ ç¼–æ’çš„åŠ¨ä½œã€ä»¥åŠä½ ä½¿ç”¨function callingå¾—åˆ°çš„æ—¶é—´ã€å¤©æ°”ã€ä½ç½®å’Œæ•°æ®åº“ä¿¡æ¯ï¼Œä»¥ç¬¬ä¸€äººç§°è¾“å‡ºä½ å›å¤æˆ‘çš„è¯ï¼Œä¸è¦è¶…è¿‡40ä¸ªå­—ã€‚

ã€ä»¥ä¸‹æ˜¯ä¸€äº›å…·ä½“çš„ä¾‹å­ã€‘
æˆ‘çš„æŒ‡ä»¤ï¼šçœ‹çœ‹æ¡Œä¸Šéƒ½æœ‰å•¥ï¼Ÿä½ è¾“å‡ºï¼š{"function":["QwenVL_api('çœ‹çœ‹æ¡Œä¸Šéƒ½æœ‰å•¥')","send_data_microbit(ser, "fabulous")"], "response":"å¥½çš„ï¼Œæˆ‘å¸®ä½ çœ‹çœ‹æ¡Œå­ä¸Šéƒ½æœ‰ä»€ä¹ˆ"}
æˆ‘çš„æŒ‡ä»¤ï¼šæˆ‘é¥¿äº†æ¡Œä¸Šæœ‰æ²¡æœ‰ä»€ä¹ˆåƒçš„ï¼Ÿä½ è¾“å‡ºï¼š{"function":["QwenVL_api('æˆ‘é¥¿äº†æ¡Œä¸Šæœ‰æ²¡æœ‰ä»€ä¹ˆåƒçš„?')","send_data_microbit(ser, "fabulous")"], "response":"æˆ‘ç…ç…æœ‰å•¥ç¾å‘³çš„ä¸œè¥¿"}
æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªè‹¹æœ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('redapple')","send_data_microbit(ser, "yes")"], "response":"æˆ‘æ¥å¸®ä½ æ‹¿ä¸€ä¸ªè‹¹æœ"}
æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªç»¿è‹¹æœ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('greenapple')","send_data_microbit(ser, "yes")"], "response":"ç°åœ¨å°±ç»™ä½ æ‹¿ä¸€ä¸ªç»¿è‹¹æœ"}
æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªæ¢¨å­ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('pear')","send_data_microbit(ser, "yes")"], "response":"å¥½çš„ï¼Œä¸ºä½ æŠ“ä¸€ä¸ªæ¢¨å­"}
æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªæ¢¨å­ï¼Œå†ç»™æˆ‘ä¸€ä¸ªè‹¹æœ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('pear')","top_view_shot()","vlm_move('redapple')","send_data_microbit(ser, "yes")"], "response":"äº†è§£ï¼Œå…ˆç»™ä½ æŠ“ä¸€ä¸ªå¤šæ±å‘³çš„æ¢¨å­ï¼Œå†ç»™ä½ æ¥ä¸€ä¸ªå¯å£çš„è‹¹æœ"}
æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªæ©™å­ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('orange')","send_data_microbit(ser, "yes")"], "response":"å¸®ä½ æ‹¿ä¸€ä¸ªåˆå¤§åˆç”œçš„æ©™å­"}
æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªæ¡ƒå­ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('peach')","send_data_microbit(ser, "yes")"], "response":"æˆ‘æ¥å¸®ä½ æ‹¿ä¸€ä¸ªç¾å‘³å¤šæ±çš„æ¡ƒå­"}
æˆ‘çš„æŒ‡ä»¤: ç»™æˆ‘ä¸€ä¸ªæ¢¨å­ï¼Œå†ç»™æˆ‘ä¸€ä¸ªè‹¹æœï¼Œå†ç»™æˆ‘ä¸€ä¸ªé’è‹¹æœ ä½ è¾“å‡ºï¼š {"function":["top_view_shot()","vlm_move('pear')","top_view_shot()","vlm_move('redapple')","top_view_shot()","vlm_move('greenapple')","send_data_microbit(ser, "yes")"], "response":"å¥½çš„å…ˆç»™ä½ æŠ“ä¸€ä¸ªç¾å‘³å‘³çš„æ¢¨å­ï¼Œå†ç»™ä½ æ¥ä¸€ä¸ªçº¢çº¢çš„è‹¹æœï¼Œæœ€åæ˜¯é…¸æºœæºœçš„é’è‹¹æœ"}
æˆ‘çš„æŒ‡ä»¤: ä¸‹æ¬¡å†èŠï¼Œå†è§ ä½ è¾“å‡ºï¼š{"send_data_microbit(ser,"heart")","function":["sys.exit(0)"], "response":"å¥½çš„ï¼Œä¸‹æ¬¡å†èŠï¼Œæ‹œæ‹œ~"}
æˆ‘çš„æŒ‡ä»¤: æ¥æ‰“ä¸ªæ‹›å‘¼å§ ä½ è¾“å‡ºï¼š{"function":["say_hello()","send_data_microbit(ser,"happy")"], "response":"ä½ å¥½å•Šï¼Œæˆ‘æ˜¯ä½ çš„æœºå™¨è‡‚åŠ©æ‰‹ï¼Œå¦‚æœæœ‰ä»€ä¹ˆéœ€è¦è¯·å‘Šè¯‰æˆ‘"}
æˆ‘çš„æŒ‡ä»¤: ä½ å¼€å¿ƒå—ï¼Ÿ ä½ è¾“å‡ºï¼š{"function":["send_data_microbit(ser, "happy")"], "response":"æˆ‘å¾ˆå¼€å¿ƒï¼Œæ„Ÿè°¢ä½ çš„å…³å¿ƒ"}

ã€æ³¨æ„ã€‘
åªæœ‰ä¸Šé¢ã€æ‰€æœ‰å†…ç½®å‡½æ•°ä»‹ç»ã€‘é‡Œæåˆ°çš„å‡½æ•°å¯ä»¥åœ¨ä½ æœ€åè¿”å›çš„çš„jsonæ ¼å¼ä¸­çš„'function'é”®ä¸­å‡ºç°ã€‚
ç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠæ—¶é—´ã€å¤©æ°”ã€ä½ç½®ä»¥åŠæ•°æ®åº“çš„æ“ä½œçš„æ—¶å€™ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å·¥å…·è€Œä¸éœ€è¦åœ¨jsonæ ¼å¼ä¸­å†™å‡ºæ–°çš„å‡½æ•°ï¼
ã€æˆ‘ç°åœ¨çš„æŒ‡ä»¤æ˜¯ã€‘
'''

ALLOWED_FUNCTIONS = {
    "top_view_shot", 
    "QwenVL_api", 
    "vlm_move", 
    "say_hello", 
    "time.sleep", 
    "sys.exit", 
    "send_data_microbit"
}

FRUIT_WHITELIST = {"pear", "redapple", "greenapple", "orange", "peach"}
MICROBIT_COMMANDS = {"happy", "sad", "heart", "yes", "no", "fabulous", "duck", "cow", "rabbit", "angry", "confused", "meh", "asleep", "0", "1", "2", "3", "custom", "scroll", "flash", "birthday", "wedding"}

def clean_function_list(functions):
    cleaned = []
    for func in functions:
        try:
            # æå–å‡½æ•°åå’Œå‚æ•°
            func_name_part = func.split("(")[0].strip()
            if func_name_part not in ALLOWED_FUNCTIONS:
                print(f"âš ï¸ éæ³•å‡½æ•°è¢«è¿‡æ»¤: {func}")
                continue

            # å‚æ•°æ£€æŸ¥ï¼ˆæ ¹æ®å‡½æ•°åï¼‰
            if func_name_part == "vlm_move":
                fruit = func.split("'")[1]
                if fruit not in FRUIT_WHITELIST:
                    print(f"âš ï¸ éæ³•æ°´æœå‚æ•°è¢«è¿‡æ»¤: {fruit}")
                    continue

            elif func_name_part == "send_data_microbit":
                command = func.split("'")[1]
                if command not in MICROBIT_COMMANDS:
                    print(f"âš ï¸ éæ³• micro:bit å‘½ä»¤è¢«è¿‡æ»¤: {command}")
                    continue

            # åˆæ³•å‡½æ•°ä¿ç•™
            cleaned.append(func)

        except Exception as e:
            print(f"âš ï¸ å‡½æ•°è§£æé”™è¯¯: {func}, é”™è¯¯: {e}")
            continue

    return cleaned

def agent_plan(AGENT_PROMPT):
    print('æ­£åœ¨ç†è§£æ„å›¾...')
    PROMPT = AGENT_SYS_PROMPT + AGENT_PROMPT
    raw_output = qwen_agent(PROMPT)
    # raw_output = wenxin_llm(PROMPT)
    # raw_output = qwen_llm(PROMPT)
    
    try:
        plan = eval(raw_output)  # å°†å­—ç¬¦ä¸²è½¬ä¸º dict
        plan["function"] = clean_function_list(plan.get("function", []))
        return str(plan)
    except Exception as e:
        print("JSON è§£æå¤±è´¥:", e)
        return '{"function": [], "response": "æŠ±æ­‰ï¼Œæˆ‘æ— æ³•ç†è§£è¿™ä¸ªè¯·æ±‚ã€‚"}'


def exit():
    sys.exit(0)

if __name__ == "__main__":
    print(agent_plan("è¯·åˆ›å»ºä¸€ä¸ªæ•°æ®åº“students.db"))